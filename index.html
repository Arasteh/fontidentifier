<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Persian Font Identifier – Live Ranking MVP</title>

<style>
body {
  font-family: system-ui;
  max-width: 850px;
  margin: 40px auto;
  background: #f4f4f4;
}

h1 { text-align: center; }

.card {
  background: white;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
}

button {
  padding: 8px 14px;
  cursor: pointer;
  margin-top: 15px;
  margin-left: 5px;
}

.result {
  padding: 8px;
  background: #e8f0ff;
  margin-bottom: 6px;
  border-radius: 6px;
  font-size: 14px;
}

.progress-bar-container {
  background: #ddd;
  height: 10px;
  border-radius: 5px;
  margin-bottom: 15px;
}

.progress-bar {
  height: 10px;
  background: #4a78ff;
  width: 0%;
  border-radius: 5px;
  transition: width 0.3s ease;
}

.summary-item {
  background: #f0f0f0;
  padding: 6px;
  border-radius: 6px;
  margin-bottom: 4px;
  font-size: 13px;
}
</style>
</head>
<body>

<h1>Font Finder – Live Ranking</h1>

<div class="card">
  <div class="progress-bar-container">
    <div class="progress-bar" id="progressBar"></div>
  </div>

  <div id="questionContainer"></div>

  <div>
    <button onclick="prevStep()">سؤال قبلی</button>
    <button onclick="nextStep()">سؤال بعدی</button>
  </div>
</div>

<div class="card">
  <h3>خلاصه انتخاب‌ها:</h3>
  <div id="summary"></div>

  <h3>رتبه‌بندی فعلی فونت‌ها:</h3>
  <div id="liveResults"></div>
</div>

<script>
let database;
let featureKeys = [];
let currentStep = 0;
let selectedAnswers = {};

fetch('database.json')
  .then(res => res.json())
  .then(data => {
    database = data;
    featureKeys = rankFeaturesByDiscrimination();
    renderQuestion();
    updateLiveResults();
  });

/* --------- مرتب‌سازی ویژگی‌ها --------- */
function rankFeaturesByDiscrimination() {
  const keys = Object.keys(database.features);

  return keys.sort((a,b) => diversityScore(b) - diversityScore(a));
}

function diversityScore(featureKey) {
  const values = new Set();
  database.fonts.forEach(font => {
    const v = font.features[featureKey];
    if (Array.isArray(v)) v.forEach(x => values.add(x));
    else values.add(v);
  });
  return values.size;
}

/* --------- رندر سؤال --------- */
function renderQuestion() {

  if (currentStep >= featureKeys.length)
    currentStep = featureKeys.length - 1;

  const key = featureKeys[currentStep];
  const feature = database.features[key];
  const container = document.getElementById("questionContainer");

  updateProgress();

  container.innerHTML = `<label>${feature.label_fa}</label><br/>`;

  if (feature.type === "categorical") {
    const select = document.createElement("select");
    select.id = "answer";

    const empty = document.createElement("option");
    empty.value = "";
    empty.textContent = "انتخاب کنید";
    select.appendChild(empty);

    feature.values.forEach(v => {
      const option = document.createElement("option");
      option.value = v;
      option.textContent = v;
      select.appendChild(option);
    });

    if (selectedAnswers[key])
      select.value = selectedAnswers[key];

    container.appendChild(select);
  }

  if (feature.type === "numeric") {
    const input = document.createElement("input");
    input.type = "range";
    input.min = 0;
    input.max = 1;
    input.step = 0.1;
    input.value = selectedAnswers[key] || 0.5;
    input.id = "answer";

    const label = document.createElement("div");
    label.innerText = input.value;

    input.oninput = () => {
      label.innerText = input.value;
      selectedAnswers[key] = input.value;
      updateLiveResults();
      renderSummary();
    };

    container.appendChild(input);
    container.appendChild(label);
  }
}

/* --------- مرحله بعد --------- */
function nextStep() {
  const answerEl = document.getElementById("answer");
  if (!answerEl) return;

  const value = answerEl.value;
  const key = featureKeys[currentStep];

  if (value !== "")
    selectedAnswers[key] = value;

  updateLiveResults();
  renderSummary();

  if (currentStep < featureKeys.length - 1)
    currentStep++;

  renderQuestion();
}

/* --------- مرحله قبل --------- */
function prevStep() {
  if (currentStep > 0)
    currentStep--;

  renderQuestion();
}

/* --------- محاسبه امتیاز کامل --------- */
function calculateScores() {
  const results = database.fonts.map(font => {
    let score = 0;
    let total = 0;

    for (let key in selectedAnswers) {
      const value = selectedAnswers[key];
      const fontValue = font.features[key];
      total++;

      if (Array.isArray(fontValue)) {
        if (fontValue.includes(value)) score++;
      } else {
        const diff = Math.abs(parseFloat(fontValue) - parseFloat(value));
        score += Math.max(0, 1 - diff);
      }
    }

    const percentage = total > 0 ? Math.round((score / total) * 100) : 0;

    return {
      name: font.name,
      percentage
    };
  });

  results.sort((a,b)=>b.percentage - a.percentage);
  return results;
}

/* --------- نمایش زنده نتایج --------- */
function updateLiveResults() {
  const container = document.getElementById("liveResults");
  container.innerHTML = "";

  const results = calculateScores();

  results.forEach(r => {
    container.innerHTML += `
      <div class="result">
        <strong>${r.name}</strong> — ${r.percentage}%
      </div>
    `;
  });
}

/* --------- خلاصه انتخاب‌ها --------- */
function renderSummary() {
  const container = document.getElementById("summary");
  container.innerHTML = "";

  Object.entries(selectedAnswers).forEach(([key,value]) => {
    const label = database.features[key].label_fa;
    container.innerHTML += `
      <div class="summary-item">
        ${label}: ${value}
      </div>
    `;
  });
}

/* --------- پیشرفت --------- */
function updateProgress() {
  const percent = (currentStep / featureKeys.length) * 100;
  document.getElementById("progressBar").style.width = percent + "%";
}
</script>

</body>
</html>

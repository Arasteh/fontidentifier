<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Persian Font Identifier – Advanced MVP</title>

<style>
body {
  font-family: sans-serif;
  max-width: 800px;
  margin: 40px auto;
  background: #f4f4f4;
}

h1 { text-align: center; }

.card {
  background: white;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
}

button {
  padding: 10px 16px;
  cursor: pointer;
  margin-top: 15px;
}

.result {
  padding: 10px;
  background: #e8f0ff;
  margin-bottom: 10px;
  border-radius: 6px;
}

.hidden { display: none; }

.progress-bar-container {
  background: #ddd;
  height: 10px;
  border-radius: 5px;
  margin-bottom: 15px;
}

.progress-bar {
  height: 10px;
  background: #4a78ff;
  width: 0%;
  border-radius: 5px;
  transition: width 0.3s ease;
}

.summary-item {
  background: #f0f0f0;
  padding: 8px;
  border-radius: 6px;
  margin-bottom: 6px;
}
</style>
</head>
<body>

<h1>Font Finder – Advanced MVP</h1>

<div class="card" id="questionCard">
  <div class="progress-bar-container">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div id="questionContainer"></div>
  <button onclick="nextStep()">ادامه</button>
</div>

<div class="card hidden" id="resultsCard">
  <h3>خلاصه انتخاب‌ها:</h3>
  <div id="summary"></div>

  <h3>نتایج:</h3>
  <div id="results"></div>
  <button onclick="restart()">شروع دوباره</button>
</div>

<script>
let database;
let featureKeys = [];
let currentStep = 0;
let selectedAnswers = {};
let activeFonts = [];

fetch('database.json')
  .then(res => res.json())
  .then(data => {
    database = data;
    featureKeys = rankFeaturesByDiscrimination();
    activeFonts = database.fonts.map(f => ({...f, _score:0}));
    renderQuestion();
  });

/* ---------- Feature Ranking (Entropy-lite) ---------- */
function rankFeaturesByDiscrimination() {
  const keys = Object.keys(database.features);

  return keys.sort((a,b) => {
    return diversityScore(b) - diversityScore(a);
  });
}

function diversityScore(featureKey) {
  const values = new Set();
  database.fonts.forEach(font => {
    const v = font.features[featureKey];
    if (Array.isArray(v)) v.forEach(x => values.add(x));
    else values.add(v);
  });
  return values.size;
}

/* ---------- Render Question ---------- */
function renderQuestion() {
  if (currentStep >= featureKeys.length || activeFonts.length <= 1) {
    showResults();
    return;
  }

  const key = featureKeys[currentStep];
  const feature = database.features[key];
  const container = document.getElementById("questionContainer");

  updateProgress();

  container.innerHTML = `<label>${feature.label_fa}</label><br/>`;

  if (feature.type === "categorical") {
    const select = document.createElement("select");
    select.id = "answer";

    const empty = document.createElement("option");
    empty.value = "";
    empty.textContent = "انتخاب کنید";
    select.appendChild(empty);

    feature.values.forEach(v => {
      const option = document.createElement("option");
      option.value = v;
      option.textContent = v;
      select.appendChild(option);
    });

    container.appendChild(select);
  }

  if (feature.type === "numeric") {
    const input = document.createElement("input");
    input.type = "range";
    input.min = 0;
    input.max = 1;
    input.step = 0.1;
    input.value = 0.5;
    input.id = "answer";

    const label = document.createElement("div");
    label.innerText = "0.5";

    input.oninput = () => label.innerText = input.value;

    container.appendChild(input);
    container.appendChild(label);
  }
}

/* ---------- Next Step ---------- */
function nextStep() {
  const answerEl = document.getElementById("answer");
  if (!answerEl || answerEl.value === "") return;

  const key = featureKeys[currentStep];
  const value = answerEl.value;

  selectedAnswers[key] = value;
  scoreFonts(key, value);

  currentStep++;
  renderQuestion();
}

/* ---------- Scoring + Early Elimination ---------- */
function scoreFonts(key, value) {

  activeFonts.forEach(font => {
    let score = 0;
    const fontValue = font.features[key];

    if (Array.isArray(fontValue)) {
      if (fontValue.includes(value)) score = 1;
    } else {
      const diff = Math.abs(parseFloat(fontValue) - parseFloat(value));
      score = Math.max(0, 1 - diff);
    }

    font._score += score;
  });

  const maxPossible = currentStep + 1;
  activeFonts = activeFonts.filter(f => {
    const ratio = f._score / maxPossible;
    return ratio > 0.3;  // حذف زودهنگام
  });
}

/* ---------- Results ---------- */
function showResults() {
  document.getElementById("questionCard").classList.add("hidden");
  document.getElementById("resultsCard").classList.remove("hidden");

  const totalQuestions = Object.keys(selectedAnswers).length;

  activeFonts.forEach(f => {
    f._percentage = Math.round((f._score / totalQuestions) * 100);
  });

  activeFonts.sort((a,b)=>b._percentage - a._percentage);

  renderSummary();
  renderResults();
}

function renderSummary() {
  const container = document.getElementById("summary");
  container.innerHTML = "";

  Object.entries(selectedAnswers).forEach(([key,value]) => {
    const label = database.features[key].label_fa;
    container.innerHTML += `
      <div class="summary-item">
        ${label}: ${value}
      </div>
    `;
  });
}

function renderResults() {
  const container = document.getElementById("results");
  container.innerHTML = "";

  activeFonts.forEach(font => {
    container.innerHTML += `
      <div class="result">
        <strong>${font.name}</strong> — ${font._percentage}%
      </div>
    `;
  });
}

/* ---------- UI ---------- */
function updateProgress() {
  const percent = (currentStep / featureKeys.length) * 100;
  document.getElementById("progressBar").style.width = percent + "%";
}

function restart() {
  currentStep = 0;
  selectedAnswers = {};
  activeFonts = database.fonts.map(f => ({...f, _score:0}));
  document.getElementById("resultsCard").classList.add("hidden");
  document.getElementById("questionCard").classList.remove("hidden");
  renderQuestion();
}
</script>

</body>
</html>

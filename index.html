<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Font Finder Pro | جستجوگر و مقایسه فونت</title>
    <style>
        :root {
            --primary: #4a78ff;
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #333;
            --border: #edf0f5;
            --input-bg: #ffffff;
            --table-header: #f8f9fa;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        .container { max-width: 1100px; margin: 0 auto; }
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
            background: var(--card);
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }
        .tab-button {
            flex: 1;
            padding: 14px;
            text-align: center;
            background: rgba(0,0,0,0.05);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            color: var(--text);
        }
        .tab-button.active {
            background: var(--card);
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
        }
        .tab-content {
            display: none;
            background: var(--card);
            border-radius: 0 0 12px 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 20px;
        }
        .tab-content.active { display: block; }
        .layout { display: grid; grid-template-columns: 1fr 340px; gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); height: fit-content; border: 1px solid var(--border); }
        h1 { color: var(--primary); margin-bottom: 25px; text-align: center; font-size: 24px; }
        h3 { margin-top: 0; font-size: 16px; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; color: var(--text); }
        .chip {
            display: inline-block;
            padding: 8px 16px;
            margin: 4px;
            background: rgba(0,0,0,0.05);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            color: var(--text);
        }
        .chip.selected { background: var(--primary); color: white; }
        .chip.history { background: rgba(74, 120, 255, 0.1); color: var(--primary); font-size: 11px; padding: 4px 10px; border: 1px solid rgba(74, 120, 255, 0.2); }
        .chip.skip { background: #ffebee; color: #c62828; font-weight: 500; }
        .visual-container {
            margin: 20px 0 10px;
            background: rgba(0,0,0,0.02);
            border-radius: 10px;
            border: 1px dashed var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .ratio-visual {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 30px;
            height: 140px;
            width: 100%;
            position: relative;
            cursor: ns-resize;
            user-select: none;
        }
        .rect {
            width: 40px;
            background: var(--primary);
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: height 0.1s ease;
            pointer-events: none;
        }
        .rect.base { background: #ddd; height: 100%; border-radius: 4px; }
        .rect-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            color: var(--text);
        }
        .contrast-visual {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 50px;
            height: 100px;
            width: 100%;
        }
        .circle-wrapper {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .circle {
            background: var(--primary);
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        .circle.fixed { width: 60px; height: 60px; background: #ddd; }
        .circle.dynamic { width: 60px; height: 60px; }
        .slider-box { width: 100%; max-width: 300px; }
        input[type=range] { width: 100%; cursor: pointer; }
        .numeric-controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 10px;
        }
        .result-item {
            padding: 8px 12px;
            margin-bottom: 6px;
            border-radius: 6px;
            background: var(--card);
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .font-link { text-decoration: none; color: inherit; display: flex; align-items: center; gap: 6px; flex-grow: 1; }
        .font-link:hover .font-name { color: var(--primary); }
        .weight-name { font-size: 10px; color: #888; background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 3px; }
        .match-score { font-size: 14px; color: var(--primary); opacity: 0.8; font-weight: bold; }
        #compareTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 15px;
            color: var(--text);
        }
        #compareTable th, #compareTable td {
            padding: 10px 8px;
            border: 1px solid var(--border);
            text-align: right;
        }
        #compareTable th { background: var(--table-header); font-weight: bold; }
        #compareTable tr:hover { background: rgba(74, 120, 255, 0.05); }
        .controls { display: flex; justify-content: space-between; margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border); }
        
        select {
            background-color: var(--input-bg);
            color: var(--text);
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 100%;
        }

        button { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 13px; transition: 0.2s; }
        button#nextBtn { background: var(--primary); color: white; }
        button.skip-btn { background: #fff3e0; color: #ef6c00; border: 1px solid #ff9800; }
        button.confirm-btn { background: #4caf50; color: white; }

        @media(max-width: 900px) { .layout { grid-template-columns: 1fr; } }

        /* Dark Mode Overrides */
        @media (prefers-color-scheme: dark) {
            :root { 
                --bg: #121212; 
                --card: #1e1e1e; 
                --text: #e0e0e0; 
                --border: #333333; 
                --input-bg: #2d2d2d;
                --table-header: #252525;
            }
            .chip { background: #2d2d2d; color: #e0e0e0; }
            .chip.history { background: rgba(74, 120, 255, 0.15); border-color: rgba(74, 120, 255, 0.3); }
            .chip.skip { background: #422222; color: #ff8a80; }
            .visual-container { background: #181818; }
            .rect.base { background: #444; }
            .circle.fixed { background: #444; }
            button { background: #333; color: #e0e0e0; }
            button.skip-btn { background: #3e2723; color: #ffccbc; border-color: #5d4037; }
            #compareTable tr:hover { background: rgba(74, 120, 255, 0.1); }
            .weight-name { background: #333; color: #bbb; }
            p[style*="color:#666"], p[style*="color:#555"], label[style*="color:#555"] { color: #aaa !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>جستجوگر و مقایسه فونت</h1>

    <div class="tabs">
        <button class="tab-button active" onclick="openTab('tab-detect')">تشخیص فونت</button>
        <button class="tab-button" onclick="openTab('tab-compare')">مقایسه</button>
    </div>

    <div id="tab-detect" class="tab-content active">
        <div class="layout">
            <div class="card">
                <div id="historyChips" style="margin-bottom: 15px;"></div>
                <div id="questionContainer">
                    <p style="text-align:center; color:#888;">در حال بارگذاری داده‌ها...</p>
                </div>
                <div class="controls">
                    <div>
                        <button onclick="prevStep()">قبلی</button>
                        <button id="nextBtn" onclick="nextStep()">بعدی</button>
                    </div>
                    <button onclick="resetAll()" style="color: #888; background: transparent;">شروع از نو</button>
                </div>
            </div>
            <div class="card">
                <h3>نتایج تطبیق یافته (بالای ۵۰٪)</h3>
                <div id="results"></div>
            </div>
        </div>
    </div>

    <div id="tab-compare" class="tab-content">
        <div class="card">
            <h3>مقایسه فونت‌ها</h3>
            <p style="color:#666; margin-bottom:20px;">فونت‌ها را انتخاب کنید — ویژگی‌های متفاوت در جدول نمایش داده می‌شوند.</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div>
                    <label style="font-size:13px; display:block; margin-bottom:6px; color:#555;">فونت اول</label>
                    <select id="font1Select" onchange="autoCompare()"></select>
                </div>
                <div>
                    <label style="font-size:13px; display:block; margin-bottom:6px; color:#555;">فونت دوم</label>
                    <select id="font2Select" onchange="autoCompare()"></select>
                </div>
            </div>
            <div id="compareResult" style="margin-top:20px; min-height:200px;"></div>
        </div>
    </div>
</div>

<script>
let database = null;
let featureKeys = [];
let currentStep = 0;
let selectedAnswers = {};
let allFontOptions = [];

const priorityFeatures = ["mono_contrast", "lam_alef_shape"];

async function init() {
    try {
        const response = await fetch('database.json');
        if (!response.ok) throw new Error('فایل دیتابیس یافت نشد.');
        database = await response.json();

        // Ensure baseline features exist
        if (!database.features.contrast) {
            database.features.contrast = { label_fa: "کنتراست ضخامت", type: "numeric" };
        }

        database.features.mono_contrast = {
            label_fa: "مونولاین یا باکنتراست",
            type: "categorical",
            values: ["مونولاین", "باکُنتراست"]
        };

        database.features.lam_alef_shape = {
            label_fa: "شکل ترکیب «لا»",
            type: "categorical",
            values: ["پایین مثلثی", "ساده پیوسته", "ساده جدا"]
        };

        const originalKeys = Object.keys(database.features)
            .filter(k => !["mono_contrast", "lam_alef_shape"].includes(k));

        featureKeys = ["mono_contrast", "lam_alef_shape", ...originalKeys];

        loadFromURL();

        allFontOptions = [];
        database.fonts.forEach(font => {
            const base = font.features || {};
            if (font.weights && Object.keys(font.weights).length > 0) {
                Object.keys(font.weights).forEach(w => {
                    const data = { ...base, ...font.weights[w] };
                    if (data.contrast !== undefined) {
                        data.mono_contrast = data.contrast > 0.3 ? "باکُنتراست" : "مونولاین";
                    }
                    allFontOptions.push({ display: `${font.name} — ${w}`, name: font.name, weight: w, data });
                });
            } else {
                const data = { ...base };
                if (data.contrast !== undefined) {
                    data.mono_contrast = data.contrast > 0.3 ? "باکُنتراست" : "مونولاین";
                }
                allFontOptions.push({ display: font.name, name: font.name, weight: null, data });
            }
        });

        const instances = allFontOptions.map(o => o.data);

        const computeDistinction = (key) => {
            const feat = database.features[key];
            if (!feat) return 0;
            const vals = instances.map(i => i[key]).filter(v => v !== undefined && v !== null);
            if (vals.length < 2) return 0;
            let entropy = 0;
            const total = vals.length;
            if (feat.type === "numeric") {
                const minV = Math.min(...vals);
                const maxV = Math.max(...vals);
                if (minV === maxV) return 0;
                const numBins = 10;
                const binCounts = new Array(numBins).fill(0);
                const range = maxV - minV;
                vals.forEach(v => {
                    let bin = Math.floor(((v - minV) / range) * (numBins - 1e-10));
                    bin = Math.max(0, Math.min(numBins - 1, bin));
                    binCounts[bin]++;
                });
                binCounts.forEach(c => {
                    if (c > 0) {
                        const p = c / total;
                        entropy -= p * Math.log2(p);
                    }
                });
            } else {
                const valueCounts = {};
                vals.forEach(v => {
                    const sig = String(v);
                    valueCounts[sig] = (valueCounts[sig] || 0) + 1;
                });
                Object.values(valueCounts).forEach(c => {
                    if (c > 0) {
                        const p = c / total;
                        entropy -= p * Math.log2(p);
                    }
                });
            }
            return entropy;
        };

        const distinctionMap = {};
        featureKeys.forEach(key => distinctionMap[key] = computeDistinction(key));

        let orderedKeys = [];
        if (priorityFeatures.length > 0) {
            priorityFeatures.forEach(key => {
                if (featureKeys.includes(key)) orderedKeys.push(key);
            });
            const remaining = featureKeys.filter(k => !priorityFeatures.includes(k));
            remaining.sort((a, b) => (distinctionMap[b] || 0) - (distinctionMap[a] || 0));
            orderedKeys = [...orderedKeys, ...remaining];
        } else {
            orderedKeys = featureKeys.sort((a, b) => (distinctionMap[b] || 0) - (distinctionMap[a] || 0));
        }
        featureKeys = orderedKeys;

        populateCompareSelects();
        renderQuestion();
        updateResults();
    } catch (error) {
        console.error('Error loading database:', error);
        document.getElementById("questionContainer").innerHTML = 
            `<p style="color:red; text-align:center;">خطا در بارگذاری دیتابیس. لطفا فایل database.json را بررسی کنید.</p>`;
    }
}

function populateCompareSelects() {
    const sel1 = document.getElementById('font1Select');
    const sel2 = document.getElementById('font2Select');
    sel1.innerHTML = '<option value="">انتخاب کنید...</option>';
    sel2.innerHTML = '<option value="">انتخاب کنید...</option>';
    allFontOptions.forEach((opt, i) => {
        const optHTML = `<option value="${i}">${opt.display}</option>`;
        sel1.innerHTML += optHTML;
        sel2.innerHTML += optHTML;
    });
}

function autoCompare() {
    const idx1 = parseInt(document.getElementById("font1Select").value);
    const idx2 = parseInt(document.getElementById("font2Select").value);
    const resultDiv = document.getElementById("compareResult");

    const f1 = isNaN(idx1) ? null : allFontOptions[idx1];
    const f2 = isNaN(idx2) ? null : allFontOptions[idx2];

    if (!f1 && !f2) {
        resultDiv.innerHTML = `<p style="text-align:center; color:#888; padding:40px 0;">لطفاً حداقل یک فونت انتخاب کنید.</p>`;
        return;
    }

    let html = `<table id="compareTable"><thead><tr><th>ویژگی</th>`;
    if (f1) html += `<th>${f1.display}</th>`;
    if (f2) html += `<th>${f2.display}</th>`;
    html += `</tr></thead><tbody>`;

    let hasVisibleRows = false;
    const isComparingTwo = f1 && f2;

    // فقط کلیدهای اصلی ویژگی‌ها (نه mono_contrast که محاسباتی است)
    Object.keys(database.features).forEach(key => {
        // mono_contrast را جداگانه مدیریت می‌کنیم و اینجا تکرار نمی‌کنیم
        if (key === "mono_contrast") return;

        const label = database.features[key].label_fa || key;

        // مقدار واقعی از داده فونت بگیریم
        let v1 = f1 ? (f1.data[key] ?? "—") : "—";
        let v2 = f2 ? (f2.data[key] ?? "—") : "—";

        // برای mono_contrast مقدار محاسبه‌شده را استفاده کنیم
        if (key === "contrast" && f1?.data.contrast !== undefined) {
            v1 = f1.data.contrast > 0.3 ? "باکُنتراست" : "مونولاین";
        }
        if (key === "contrast" && f2?.data.contrast !== undefined) {
            v2 = f2.data.contrast > 0.3 ? "باکُنتراست" : "مونولاین";
        }

        let shouldShow = false;

        if (isComparingTwo) {
            // شرط اصلی: هر دو مقدار معتبر باشند و با هم متفاوت باشند
            const bothDefined = v1 !== "—" && v2 !== "—";
            const valuesDiffer  = v1 !== v2;
            shouldShow = bothDefined && valuesDiffer;
        } else {
            // فقط یک فونت انتخاب شده → ویژگی‌هایی که مقدار دارند نمایش داده شوند
            shouldShow = (f1 && v1 !== "—") || (f2 && v2 !== "—");
        }

        if (shouldShow) {
            hasVisibleRows = true;
            html += `<tr><td style="font-weight:600;">${label}</td>`;
            if (f1) html += `<td>${v1}</td>`;
            if (f2) html += `<td>${v2}</td>`;
            html += `</tr>`;
        }
    });

    html += `</tbody></table>`;

    if (!hasVisibleRows) {
        if (isComparingTwo) {
            resultDiv.innerHTML = `<p style="text-align:center; color:#888; padding:40px 0;">هیچ تفاوت قابل‌توجهی بین این دو فونت یافت نشد.</p>`;
        } else {
            resultDiv.innerHTML = `<p style="text-align:center; color:#888; padding:40px 0;">این فونت ویژگی ثبت‌شده‌ای ندارد.</p>`;
        }
    } else {
        resultDiv.innerHTML = html;
    }
}

function openTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.currentTarget.classList.add('active');
}

function updateURL() {
    if (!database) return;
    let compressed = "";
    featureKeys.forEach(key => {
        const val = selectedAnswers[key];
        if (val === undefined) compressed += "x";
        else if (val === null) compressed += "u";
        else if (database.features[key].type === "categorical") compressed += database.features[key].values.indexOf(val);
        else compressed += Math.round(val * 10);
    });
    history.replaceState(null, "", "?f=" + compressed);
}

function loadFromURL() {
    if (!database) return;
    const params = new URLSearchParams(location.search);
    const str = params.get("f");
    if (!str) return;
    featureKeys.forEach((key, i) => {
        const char = str[i];
        if (!char || char === "x") return;
        if (char === "u") { selectedAnswers[key] = null; return; }
        const feat = database.features[key];
        if (feat.type === "categorical") selectedAnswers[key] = feat.values[parseInt(char)];
        else selectedAnswers[key] = parseInt(char) / 10;
    });
}

function renderQuestion() {
    if (!database) return;
    const key = featureKeys[currentStep];
    const feature = database.features[key];
    const container = document.getElementById("questionContainer");
    const nextBtn = document.getElementById("nextBtn");

    container.innerHTML = `<h4 style="margin:0 0 15px 0;">${feature.label_fa}</h4>`;
    renderHistory();

    const currentVal = selectedAnswers[key];
    nextBtn.innerText = "بعدی";

    if (feature.type === "categorical") {
        const chipContainer = document.createElement("div");
        feature.values.forEach(val => {
            const chip = document.createElement("div");
            chip.className = `chip ${currentVal === val ? 'selected' : ''}`;
            chip.innerText = val;
            chip.onclick = () => {
                selectedAnswers[key] = val;
                updateURL();
                if (currentStep < featureKeys.length - 1) {
                    currentStep++;
                }
                renderQuestion();
                updateResults();
            };
            chipContainer.appendChild(chip);
        });

        const skipChip = document.createElement("div");
        skipChip.className = "chip skip";
        skipChip.innerText = "مطمئن نیستم";
        skipChip.onclick = () => {
            selectedAnswers[key] = null;
            updateURL();
            if (currentStep < featureKeys.length - 1) {
                currentStep++;
            }
            renderQuestion();
            updateResults();
        };
        chipContainer.appendChild(skipChip);

        container.appendChild(chipContainer);
    } 
    else if (feature.type === "numeric") {
        const val = currentVal ?? 0.5;
        const visualWrap = document.createElement("div");
        visualWrap.className = "visual-container";

        if (key === 'contrast') {
            visualWrap.innerHTML = `
                <div class="contrast-visual">
                    <div class="circle-wrapper"><div class="circle fixed"></div></div>
                    <div class="circle-wrapper"><div class="circle dynamic" id="dynCircle" style="width:${60 * (1 - val*0.99)}px; height:${60 * (1 - val*0.99)}px"></div></div>
                </div>
                <div class="slider-box">
                    <input type="range" min="0" max="1" step="0.01" value="${val}" id="contrastSlider">
                    <div style="text-align:center; font-size:12px; margin-top:5px; color:#888;">کنتراست: <span id="contrastVal">${Math.round(val*100)}%</span></div>
                </div>
            `;

            const slider = visualWrap.querySelector('#contrastSlider');
            slider.addEventListener('input', (e) => {
                const newScore = parseFloat(e.target.value);
                const dynCircle = document.getElementById('dynCircle');
                const scoreLabel = document.getElementById('contrastVal');
                const newSize = 60 * (1 - newScore * 0.99);
                dynCircle.style.width = newSize + "px";
                dynCircle.style.height = newSize + "px";
                scoreLabel.innerText = Math.round(newScore * 100) + "%";
                selectedAnswers[key] = Math.round(newScore * 10) / 10;
                updateURL();
                updateResults();
            });
        } else {
            visualWrap.innerHTML = `
                <div class="ratio-visual" id="barVisual">
                    <div class="rect" id="dragRect" style="height: ${val * 100}%"><span class="rect-label">${Math.round(val*100)}%</span></div>
                    <div class="rect base"><span class="rect-label">۱۰۰٪</span></div>
                </div>
            `;

            const visual = visualWrap.querySelector('#barVisual');
            let isDragging = false;
            const handleInteraction = (e) => {
                const rect = visual.getBoundingClientRect();
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                let percent = 1 - ((clientY - rect.top) / rect.height);
                percent = Math.max(0, Math.min(1, percent));
                const roundedVal = Math.round(percent * 10) / 10;
                
                const dragRect = document.getElementById("dragRect");
                if (dragRect) {
                    dragRect.style.height = (roundedVal * 100) + "%";
                    dragRect.querySelector('.rect-label').innerText = Math.round(roundedVal * 100) + "%";
                }
                selectedAnswers[key] = roundedVal;
                updateURL();
                updateResults();
            };
            visual.addEventListener('mousedown', (e) => { isDragging = true; handleInteraction(e); });
            window.addEventListener('mouseup', () => { isDragging = false; });
            window.addEventListener('mousemove', (e) => { if (isDragging) handleInteraction(e); });
            visual.addEventListener('touchstart', (e) => { isDragging = true; handleInteraction(e); }, {passive: false});
            window.addEventListener('touchend', () => { isDragging = false; });
            window.addEventListener('touchmove', (e) => { if (isDragging) { e.preventDefault(); handleInteraction(e); } }, {passive: false});
        }

        const btnContainer = document.createElement("div");
        btnContainer.className = "numeric-controls";

        const confirmBtn = document.createElement("button");
        confirmBtn.className = "confirm-btn";
        confirmBtn.innerText = "تأیید";
        confirmBtn.onclick = () => {
            if (currentStep < featureKeys.length - 1) {
                currentStep++;
            }
            renderQuestion();
            updateResults();
        };
        btnContainer.appendChild(confirmBtn);

        const skipBtn = document.createElement("button");
        skipBtn.className = "skip-btn";
        skipBtn.innerText = "مطمئن نیستم";
        skipBtn.onclick = () => {
            selectedAnswers[key] = null;
            updateURL();
            if (currentStep < featureKeys.length - 1) {
                currentStep++;
            }
            renderQuestion();
            updateResults();
        };
        btnContainer.appendChild(skipBtn);

        visualWrap.appendChild(btnContainer);
        container.appendChild(visualWrap);
    }
}

function nextStep() {
    if (currentStep < featureKeys.length - 1) {
        currentStep++;
        renderQuestion();
    }
}

function prevStep() {
    if (currentStep > 0) {
        currentStep--;
        renderQuestion();
    }
}

function renderHistory() {
    if (!database) return;
    const box = document.getElementById("historyChips");
    box.innerHTML = "";
    Object.keys(selectedAnswers).forEach(key => {
        const val = selectedAnswers[key];
        const chip = document.createElement("div");
        chip.className = "chip history";
        chip.innerText = `${database.features[key].label_fa}: ${val === null ? '؟' : val}`;
        chip.onclick = () => { currentStep = featureKeys.indexOf(key); renderQuestion(); };
        box.appendChild(chip);
    });
}

function updateResults() {
    if (!database) return;
    const resBox = document.getElementById("results");
    resBox.innerHTML = "";
    const hasAnyAnswer = Object.values(selectedAnswers).some(v => v !== undefined && v !== null);
    let finalFlatResults = [];
    
    database.fonts.forEach(font => {
        const calculateScore = (data) => {
            let score = 0;
            let total = 0;
            featureKeys.forEach(key => {
                const userVal = selectedAnswers[key];
                if (userVal == null) return;
                total++;
                let fontVal = data[key] ?? font.features?.[key];
                if (key === "mono_contrast") {
                    const contrastVal = data.contrast ?? font.features?.contrast;
                    if (contrastVal !== undefined) {
                        fontVal = contrastVal > 0.3 ? "باکُنتراست" : "مونولاین";
                    }
                }
                if (fontVal === undefined || fontVal === null) return;
                if (Array.isArray(fontVal)) {
                    score += fontVal.includes(userVal) ? 1 : 0;
                } else if (typeof fontVal === 'number') {
                    score += Math.max(0, 1 - Math.abs(fontVal - userVal));
                } else {
                    score += (fontVal === userVal) ? 1 : 0;
                }
            });
            return total > 0 ? (score / total) : 0;
        };
        
        if (font.weights) {
            Object.keys(font.weights).forEach(wName => {
                const s = hasAnyAnswer ? calculateScore(font.weights[wName]) : 0;
                finalFlatResults.push({ name: font.name, url: font.url, weight: wName, score: s });
            });
        } else {
            const s = hasAnyAnswer ? calculateScore(font.features) : 0;
            finalFlatResults.push({ name: font.name, url: font.url, weight: null, score: s });
        }
    });

    if (!hasAnyAnswer) {
        finalFlatResults = finalFlatResults.sort(() => Math.random() - 0.5).slice(0, 10);
    } else {
        // Logic: Hide results with score < 50%
        finalFlatResults = finalFlatResults
            .filter(r => r.score >= 0.5) 
            .sort((a, b) => b.score - a.score);
    }

    if (finalFlatResults.length === 0 && hasAnyAnswer) {
        resBox.innerHTML = "<p style='color:#999; text-align:center; font-size:13px;'>فنتی با تطابق بالای ۵۰٪ یافت نشد.</p>";
        return;
    }

    finalFlatResults.forEach(res => {
        const div = document.createElement("div");
        div.className = "result-item";
        const fontSize = 13 + (res.score * 4);
        const fontWeight = 400 + Math.round(res.score * 500);
        div.innerHTML = `
            <a href="${res.url || '#'}" target="_blank" class="font-link">
                <span class="font-name" style="font-size: ${fontSize}px; font-weight: ${fontWeight};">${res.name}</span>
                ${res.weight ? `<span class="weight-name">${res.weight}</span>` : ''}
            </a>
            ${hasAnyAnswer ? `<span class="match-score">${Math.round(res.score * 100)}%</span>` : ''}
        `;
        resBox.appendChild(div);
    });
}

function resetAll() {
    selectedAnswers = {};
    currentStep = 0;
    history.replaceState(null, "", window.location.pathname);
    renderQuestion();
    updateResults();
}

init();
</script>
</body>
</html>
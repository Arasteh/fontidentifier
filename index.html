<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Persian Font Identifier - Smart MVP</title>

<style>
body {
  font-family: sans-serif;
  max-width: 750px;
  margin: 40px auto;
  background: #f4f4f4;
}
h1 { text-align: center; }

.card {
  background: white;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
}

button {
  padding: 10px;
  cursor: pointer;
  margin-top: 10px;
}

.result {
  padding: 10px;
  background: #e8f0ff;
  margin-bottom: 10px;
  border-radius: 6px;
}

.hidden { display: none; }

.progress {
  margin-bottom: 10px;
  font-size: 14px;
  color: #666;
}
</style>
</head>
<body>

<h1>Font Finder – Smart MVP</h1>

<div class="card" id="questionCard">
  <div class="progress" id="progress"></div>
  <div id="questionContainer"></div>
  <button onclick="nextStep()">ادامه</button>
</div>

<div class="card hidden" id="resultsCard">
  <h3>نتایج:</h3>
  <div id="results"></div>
  <button onclick="restart()">شروع دوباره</button>
</div>

<script>
let database = null;
let currentStep = 0;
let selectedAnswers = {};
let featureKeys = [];
let remainingFonts = [];

fetch('database.json')
  .then(res => res.json())
  .then(data => {
    database = data;
    featureKeys = Object.keys(database.features);
    remainingFonts = [...database.fonts];
    renderQuestion();
  });

function renderQuestion() {
  const container = document.getElementById("questionContainer");
  const progress = document.getElementById("progress");

  if (currentStep >= featureKeys.length) {
    showResults();
    return;
  }

  const key = featureKeys[currentStep];
  const feature = database.features[key];

  progress.innerText = `سوال ${currentStep + 1} از ${featureKeys.length}`;

  container.innerHTML = `<label>${feature.label_fa}</label><br/>`;

  if (feature.type === "categorical") {
    const select = document.createElement("select");
    select.id = "answer";

    const empty = document.createElement("option");
    empty.value = "";
    empty.textContent = "انتخاب کنید";
    select.appendChild(empty);

    feature.values.forEach(v => {
      const option = document.createElement("option");
      option.value = v;
      option.textContent = v;
      select.appendChild(option);
    });

    container.appendChild(select);

  } else if (feature.type === "numeric") {

    const input = document.createElement("input");
    input.type = "range";
    input.min = 0;
    input.max = 1;
    input.step = 0.1;
    input.value = 0.5;
    input.id = "answer";

    const valueLabel = document.createElement("div");
    valueLabel.id = "rangeValue";
    valueLabel.innerText = "0.5";

    input.oninput = () => {
      valueLabel.innerText = input.value;
    };

    container.appendChild(input);
    container.appendChild(valueLabel);
  }
}

function nextStep() {
  const answerEl = document.getElementById("answer");
  if (!answerEl) return;

  const value = answerEl.value;
  if (value === "") return;

  const key = featureKeys[currentStep];
  selectedAnswers[key] = value;

  filterRemainingFonts(key, value);

  currentStep++;
  renderQuestion();
}

function filterRemainingFonts(key, value) {
  remainingFonts = remainingFonts.map(font => {
    let score = 0;

    const fontValue = font.features[key];

    if (Array.isArray(fontValue)) {
      if (fontValue.includes(value)) score = 1;
    } else {
      // FUZZY numeric scoring
      const diff = Math.abs(parseFloat(fontValue) - parseFloat(value));
      score = Math.max(0, 1 - diff); 
    }

    return {
      ...font,
      _score: (font._score || 0) + score
    };
  });
}

function showResults() {
  document.getElementById("questionCard").classList.add("hidden");
  document.getElementById("resultsCard").classList.remove("hidden");

  const totalQuestions = Object.keys(selectedAnswers).length;

  const scored = remainingFonts.map(f => {
    const percentage = Math.round((f._score / totalQuestions) * 100);
    return {
      name: f.name,
      score: percentage
    };
  });

  scored.sort((a,b) => b.score - a.score);

  const container = document.getElementById("results");
  container.innerHTML = "";

  scored.forEach(r => {
    container.innerHTML += `
      <div class="result">
        <strong>${r.name}</strong> — ${r.score}%
      </div>
    `;
  });
}

function restart() {
  currentStep = 0;
  selectedAnswers = {};
  remainingFonts = [...database.fonts];
  document.getElementById("resultsCard").classList.add("hidden");
  document.getElementById("questionCard").classList.remove("hidden");
  renderQuestion();
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Font Finder Pro | جستجوگر پیشرفته فونت</title>
    <style>
        :root {
            --primary: #4a78ff;
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #333;
            --border: #edf0f5;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        .container { max-width: 1100px; margin: 0 auto; }
        .layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); height: fit-content; }
        
        h1 { color: var(--primary); margin-bottom: 25px; text-align: center; font-size: 24px; }
        h3 { margin-top: 0; font-size: 16px; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; }
        
        /* Chips */
        .chip {
            display: inline-block;
            padding: 8px 16px;
            margin: 4px;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }
        .chip.selected { background: var(--primary); color: white; }
        .chip.history { background: #e8f0ff; color: var(--primary); font-size: 11px; padding: 4px 10px; }

        /* Visual Interaction */
        .ratio-visual {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 30px;
            height: 180px;
            margin: 20px 0;
            background: #fdfdfd;
            border-radius: 10px;
            position: relative;
            cursor: ns-resize;
            user-select: none;
            border: 1px dashed #ddd;
        }
        .rect {
            width: 50px;
            background: var(--primary);
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: height 0.1s ease;
        }
        .rect.base { background: #ddd; height: 100%; border-radius: 4px; }
        .rect-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
        }

        /* Results - Compact Style */
        .result-item {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            background: #fff;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .result-main { flex-grow: 1; }
        .font-info { display: flex; align-items: baseline; gap: 8px; }
        .font-name { font-size: 15px; font-weight: bold; color: #222; }
        .weight-name { font-size: 12px; color: #666; background: #f0f0f0; padding: 1px 6px; border-radius: 4px; }
        .match-score { font-size: 18px; font-weight: 900; color: var(--primary); margin-left: 12px; }
        .profile-link { font-size: 11px; color: var(--primary); text-decoration: none; border: 1px solid var(--primary); padding: 2px 8px; border-radius: 4px; }
        .profile-link:hover { background: var(--primary); color: white; }

        .controls { display: flex; justify-content: space-between; margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border); }
        button { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; background: #eee; font-family: inherit; font-size: 13px; transition: 0.2s; }
        button#nextBtn { background: var(--primary); color: white; }
        .hidden { display: none; }

        @media(max-width: 900px) { .layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <h1>جستجوگر فونت</h1>

    <div class="layout">
        <div class="card">
            <div id="historyChips" style="margin-bottom: 15px;"></div>
            <div id="questionContainer">
                <p style="text-align:center; color:#888;">در حال بارگذاری داده‌ها...</p>
            </div>

            <div class="controls">
                <div>
                    <button onclick="prevStep()">قبلی</button>
                    <button id="nextBtn" onclick="nextStep()">نمی‌دانم / بعدی</button>
                </div>
                <button onclick="resetAll()" style="color: #888; background: transparent;">شروع از نو</button>
            </div>
        </div>

        <div class="card">
            <h3>نتایج تطبیق یافته</h3>
            <div id="results"></div>
        </div>
    </div>
</div>

<script>
// متغیر سراسری برای ذخیره داده‌ها پس از بارگذاری از فایل خارجی
let database = null;
let featureKeys = [];
let currentStep = 0;
let selectedAnswers = {};

async function init() {
    try {
        // بارگذاری دیتابیس از فایل خارجی
        const response = await fetch('database.json');
        if (!response.ok) throw new Error('فایل دیتابیس یافت نشد.');
        database = await response.json();
        
        featureKeys = Object.keys(database.features);
        loadFromURL();
        renderQuestion();
        updateResults();
    } catch (error) {
        console.error('Error loading database:', error);
        document.getElementById("questionContainer").innerHTML = 
            `<p style="color:red; text-align:center;">خطا در بارگذاری دیتابیس. لطفا فایل database.json را بررسی کنید.</p>`;
    }
}

function updateURL() {
    if (!database) return;
    let compressed = "";
    featureKeys.forEach(key => {
        const val = selectedAnswers[key];
        if (val === undefined) compressed += "x";
        else if (val === null) compressed += "u";
        else if (database.features[key].type === "categorical") compressed += database.features[key].values.indexOf(val);
        else compressed += Math.round(val * 10);
    });
    history.replaceState(null, "", "?f=" + compressed);
}

function loadFromURL() {
    if (!database) return;
    const params = new URLSearchParams(location.search);
    const str = params.get("f");
    if (!str) return;
    featureKeys.forEach((key, i) => {
        const char = str[i];
        if (!char || char === "x") return;
        if (char === "u") { selectedAnswers[key] = null; return; }
        const feat = database.features[key];
        if (feat.type === "categorical") selectedAnswers[key] = feat.values[parseInt(char)];
        else selectedAnswers[key] = parseInt(char) / 10;
    });
}

function renderQuestion() {
    if (!database) return;
    const key = featureKeys[currentStep];
    const feature = database.features[key];
    const container = document.getElementById("questionContainer");
    const nextBtn = document.getElementById("nextBtn");
    
    container.innerHTML = `<h4 style="margin:0 0 15px 0; color:#555;">${feature.label_fa}</h4>`;
    renderHistory();

    const currentVal = selectedAnswers[key];
    
    if (currentStep === featureKeys.length - 1 && currentVal !== undefined) {
        nextBtn.classList.add("hidden");
    } else if (currentStep >= featureKeys.length - 1 && currentVal === undefined) {
        nextBtn.classList.remove("hidden");
        nextBtn.innerText = "پایان سوالات";
    } else {
        nextBtn.classList.remove("hidden");
        nextBtn.innerText = (currentVal == null) ? "نمی‌دانم / بعدی" : "بعدی";
    }

    if (feature.type === "categorical") {
        const chipContainer = document.createElement("div");
        feature.values.forEach(val => {
            const chip = document.createElement("div");
            chip.className = `chip ${currentVal === val ? 'selected' : ''}`;
            chip.innerText = val;
            chip.onclick = () => { 
                selectedAnswers[key] = val; 
                updateURL(); 
                renderQuestion(); 
                updateResults(); 
            };
            chipContainer.appendChild(chip);
        });
        container.appendChild(chipContainer);
    }

    if (feature.type === "numeric") {
        const val = currentVal ?? 0.5;
        const visual = document.createElement("div");
        visual.className = "ratio-visual";
        visual.innerHTML = `
            <div class="rect" id="dragRect" style="height: ${val * 100}%"><span class="rect-label">${Math.round(val*100)}%</span></div>
            <div class="rect base"><span class="rect-label">۱۰۰٪</span></div>
        `;

        let isDragging = false;
        const updateFromEvent = (e) => {
            const rect = visual.getBoundingClientRect();
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            let percent = 1 - ((clientY - rect.top) / rect.height);
            percent = Math.max(0, Math.min(1, percent));
            updateNumericValue(key, Math.round(percent * 10) / 10);
        };

        const startDrag = (e) => { isDragging = true; updateFromEvent(e); };
        const stopDrag = () => isDragging = false;
        const doDrag = (e) => { if (isDragging) { e.preventDefault(); updateFromEvent(e); } };

        visual.addEventListener('mousedown', startDrag);
        window.addEventListener('mouseup', stopDrag);
        window.addEventListener('mousemove', doDrag);
        visual.addEventListener('touchstart', startDrag, {passive: false});
        window.addEventListener('touchend', stopDrag);
        window.addEventListener('touchmove', doDrag, {passive: false});

        container.appendChild(visual);
    }
}

function updateNumericValue(key, val) {
    selectedAnswers[key] = val;
    const rect = document.getElementById("dragRect");
    if (rect) {
        rect.style.height = (val * 100) + "%";
        rect.querySelector('.rect-label').innerText = Math.round(val * 100) + "%";
    }
    updateURL();
    renderQuestion(); 
    updateResults();
}

function nextStep() {
    if (currentStep < featureKeys.length - 1) {
        const key = featureKeys[currentStep];
        if (selectedAnswers[key] === undefined) selectedAnswers[key] = null;
        currentStep++;
        renderQuestion();
    } else {
        const key = featureKeys[currentStep];
        if (selectedAnswers[key] === undefined) selectedAnswers[key] = null;
        renderQuestion();
    }
}

function prevStep() {
    if (currentStep > 0) { currentStep--; renderQuestion(); }
}

function renderHistory() {
    if (!database) return;
    const box = document.getElementById("historyChips");
    box.innerHTML = "";
    Object.keys(selectedAnswers).forEach(key => {
        const val = selectedAnswers[key];
        const chip = document.createElement("div");
        chip.className = "chip history";
        chip.innerText = `${database.features[key].label_fa}: ${val === null ? '؟' : val}`;
        chip.onclick = () => { currentStep = featureKeys.indexOf(key); renderQuestion(); };
        box.appendChild(chip);
    });
}

function updateResults() {
    if (!database) return;
    const resBox = document.getElementById("results");
    resBox.innerHTML = "";

    let finalFlatResults = [];

    database.fonts.forEach(font => {
        const calculateScore = (data) => {
            let score = 0, total = 0;
            featureKeys.forEach(key => {
                const userVal = selectedAnswers[key];
                if (userVal == null) return;
                let fontVal = data[key] ?? font.features[key];
                if (fontVal === undefined) return;

                if (Array.isArray(fontVal)) {
                    score += fontVal.includes(userVal) ? 1 : 0;
                } else if (typeof fontVal === 'number') {
                    score += Math.max(0, 1 - Math.abs(fontVal - userVal));
                } else {
                    score += (fontVal === userVal) ? 1 : 0;
                }
                total++;
            });
            return total > 0 ? (score / total) : 0;
        };

        if (font.weights) {
            Object.keys(font.weights).forEach(wName => {
                const s = calculateScore(font.weights[wName]);
                if (s > 0) finalFlatResults.push({ name: font.name, url: font.url, weight: wName, score: s });
            });
        } else {
            const s = calculateScore(font.features);
            if (s > 0) finalFlatResults.push({ name: font.name, url: font.url, weight: null, score: s });
        }
    });

    finalFlatResults.sort((a, b) => b.score - a.score);

    if (finalFlatResults.length === 0) {
        resBox.innerHTML = "<p style='color:#999; text-align:center; font-size:13px;'>منتظر پاسخ‌های شما...</p>";
        return;
    }

    finalFlatResults.forEach(res => {
        const div = document.createElement("div");
        div.className = "result-item";
        div.innerHTML = `
            <div class="result-main">
                <div class="font-info">
                    <span class="font-name">${res.name}</span>
                    ${res.weight ? `<span class="weight-name">${res.weight}</span>` : ''}
                </div>
                ${res.url ? `<a href="${res.url}" target="_blank" class="profile-link">لینک</a>` : ''}
            </div>
            <span class="match-score">${Math.round(res.score * 100)}%</span>
        `;
        resBox.appendChild(div);
    });
}

function resetAll() {
    selectedAnswers = {};
    currentStep = 0;
    history.replaceState(null, "", window.location.pathname);
    renderQuestion();
    updateResults();
}

// اجرای تابع شروع
init();
</script>
</body>
</html>
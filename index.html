<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Font Finder Pro | جستجوگر هوشمند فونت</title>
    <style>
        :root {
            --primary: #4a78ff;
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #333;
            --border: #edf0f5;
            --secondary-text: #666;
            --chip-bg: #f0f0f0;
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #121212;
                --card: #1e1e1e;
                --text: #e0e0e0;
                --border: #333;
                --secondary-text: #aaa;
                --chip-bg: #2c2c2c;
            }
            body { background: var(--bg); color: var(--text); }
            input[type=range] { opacity: 0.8; }
            .rect.base { background: #444 !important; }
            .circle.fixed { background: #444 !important; }
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }
        .container { max-width: 1100px; margin: 0 auto; }
        .layout { display: grid; grid-template-columns: 1fr 340px; gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); height: fit-content; border: 1px solid var(--border); }
        
        h1 { color: var(--primary); margin-bottom: 25px; text-align: center; font-size: 24px; }
        h3 { margin-top: 0; font-size: 16px; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; }
        
        .chip {
            display: inline-block;
            padding: 8px 16px;
            margin: 4px;
            background: var(--chip-bg);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            color: var(--text);
        }
        .chip.selected { background: var(--primary); color: white; }
        .chip.history { background: rgba(74, 120, 255, 0.15); color: var(--primary); font-size: 11px; padding: 4px 10px; }

        .visual-container {
            margin: 20px 0;
            background: rgba(128, 128, 128, 0.05);
            border-radius: 10px;
            border: 1px dashed var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .ratio-visual {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 30px;
            height: 140px;
            width: 100%;
            position: relative;
        }
        .rect {
            width: 40px;
            background: var(--primary);
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: height 0.1s ease;
        }
        .rect.base { background: #ddd; height: 100%; border-radius: 4px; }
        .rect-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            color: var(--text);
        }

        .contrast-visual {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 50px;
            height: 100px;
            width: 100%;
        }
        .circle-wrapper {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .circle {
            background: var(--primary);
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        .circle.fixed { width: 60px; height: 60px; background: #ddd; }
        .circle.dynamic { width: 60px; height: 60px; }

        .slider-box { width: 100%; max-width: 300px; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--primary); }

        .result-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: var(--card);
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .result-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .font-link {
            text-decoration: none;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 6px;
            flex-grow: 1;
        }
        .match-score {
            font-size: 14px;
            color: var(--primary);
            font-weight: bold;
        }

        .controls { display: flex; justify-content: space-between; margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border); }
        button { padding: 8px 18px; border: none; border-radius: 8px; cursor: pointer; background: var(--chip-bg); font-family: inherit; font-size: 13px; color: var(--text); transition: 0.2s; }
        button:hover { filter: brightness(0.9); }
        button#nextBtn { background: var(--primary); color: white; }
        button#nextBtn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .error-msg { color: #ff4d4d; text-align: center; padding: 20px; }

        @media(max-width: 900px) { .layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <h1>جستجوگر هوشمند فونت فارسی</h1>

    <div class="layout">
        <div class="card">
            <div id="historyChips" style="margin-bottom: 15px; min-height: 30px;"></div>
            <div id="questionContainer">
                <p style="text-align:center; color:var(--secondary-text);">در حال بارگذاری پایگاه داده...</p>
            </div>

            <div class="controls">
                <div>
                    <button id="prevBtn" onclick="prevStep()">قبلی</button>
                    <button id="nextBtn" onclick="nextStep()">نمی‌دانم / بعدی</button>
                </div>
                <button onclick="resetAll()" style="color: var(--secondary-text); background: transparent;">شروع از نو</button>
            </div>
        </div>

        <div class="card">
            <h3>نتایج پیشنهادی</h3>
            <div id="results"></div>
        </div>
    </div>
</div>

<script>
let database = null;
let dynamicFeatureOrder = []; 
let currentStep = 0;
let selectedAnswers = {};

/**
 * دریافت دیتابیس واقعی از فایل database.json
 */
async function init() {
    try {
        const response = await fetch('database.json');
        if (!response.ok) throw new Error('فایل database.json یافت نشد یا در دسترس نیست.');
        
        database = await response.json();
        
        if (!database.fonts || database.fonts.length === 0) {
            throw new Error('دیتابیس خالی است.');
        }

        calculateBestQuestionOrder();
        loadFromURL();
        renderQuestion();
        updateResults();
    } catch (error) {
        console.error('Initialization error:', error);
        document.getElementById("questionContainer").innerHTML = `
            <div class="error-msg">
                <p>خطا در بارگذاری داده‌ها:</p>
                <small>${error.message}</small>
            </div>`;
    }
}

/**
 * تعیین ترتیب سوالات بر اساس آنتروپی داده‌ها
 */
function calculateBestQuestionOrder() {
    const features = Object.keys(database.features);
    const scores = features.map(key => {
        const feat = database.features[key];
        const values = database.fonts.map(f => f.features[key]).filter(v => v !== undefined);
        
        if (values.length === 0) return { key, score: -1 };

        let diversity = 0;
        if (feat.type === "categorical") {
            const unique = new Set(values.flat());
            diversity = unique.size / (feat.values ? feat.values.length : 1);
        } else {
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            const variance = values.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / values.length;
            diversity = variance * 10;
        }
        return { key, score: diversity };
    });

    // حذف ویژگی‌های بدون داده و مرتب‌سازی
    dynamicFeatureOrder = scores
        .filter(s => s.score >= 0)
        .sort((a, b) => b.score - a.score)
        .map(s => s.key);
}

function renderQuestion() {
    if (!database || dynamicFeatureOrder.length === 0) return;
    
    const key = dynamicFeatureOrder[currentStep];
    const feature = database.features[key];
    const container = document.getElementById("questionContainer");
    const nextBtn = document.getElementById("nextBtn");
    const prevBtn = document.getElementById("prevBtn");

    prevBtn.disabled = currentStep === 0;
    container.innerHTML = `<h4 style="margin:0 0 15px 0; color:var(--primary);">${feature.label_fa}</h4>`;
    renderHistory();

    const currentVal = selectedAnswers[key];
    nextBtn.innerText = (currentVal === undefined || currentVal === null) ? "نمی‌دانم / بعدی" : "بعدی";

    if (feature.type === "categorical") {
        const chipContainer = document.createElement("div");
        feature.values.forEach(val => {
            const chip = document.createElement("div");
            chip.className = `chip ${currentVal === val ? 'selected' : ''}`;
            chip.innerText = val;
            chip.onclick = () => { 
                selectedAnswers[key] = val; 
                updateURL(); 
                updateResults();
                renderQuestion(); 
            };
            chipContainer.appendChild(chip);
        });
        container.appendChild(chipContainer);
    } else if (feature.type === "numeric") {
        const val = currentVal ?? 0.5;
        const visualWrap = document.createElement("div");
        visualWrap.className = "visual-container";

        if (key === 'contrast' || feature.label_fa.includes('تضاد') || feature.label_fa.includes('کنتراست')) {
            visualWrap.innerHTML = `
                <div class="contrast-visual">
                    <div class="circle-wrapper"><div class="circle fixed"></div></div>
                    <div class="circle-wrapper"><div class="circle dynamic" id="dynCircle" style="width:${60 * (1 - val*0.8)}px; height:${60 * (1 - val*0.8)}px"></div></div>
                </div>
                <div class="slider-box">
                    <input type="range" min="0" max="1" step="0.1" value="${val}" id="numSlider">
                    <div style="text-align:center; font-size:12px; margin-top:5px; color:var(--secondary-text);">مقدار: <span id="numVal">${Math.round(val*100)}%</span></div>
                </div>`;
        } else {
            visualWrap.innerHTML = `
                <div class="ratio-visual" id="barVisual">
                    <div class="rect" id="dragRect" style="height: ${val * 100}%"><span class="rect-label">${Math.round(val*100)}%</span></div>
                    <div class="rect base"></div>
                </div>
                <div class="slider-box">
                    <input type="range" min="0" max="1" step="0.1" value="${val}" id="numSlider">
                </div>`;
        }

        const slider = visualWrap.querySelector('#numSlider');
        slider.oninput = (e) => {
            const v = parseFloat(e.target.value);
            selectedAnswers[key] = v;
            updateURL();
            updateResults();
            renderQuestion();
        };
        container.appendChild(visualWrap);
    }
}

function updateResults() {
    if (!database) return;
    const resBox = document.getElementById("results");
    const activeKeys = Object.keys(selectedAnswers).filter(k => selectedAnswers[k] !== null);
    
    let results = [];
    database.fonts.forEach(font => {
        let matchScore = 0;
        let answeredCount = activeKeys.length;

        if (answeredCount === 0) {
            results.push({ ...font, score: 0 });
            return;
        }

        activeKeys.forEach(key => {
            const userVal = selectedAnswers[key];
            const fontVal = font.features[key];
            if (fontVal === undefined) return;

            if (database.features[key].type === "numeric") {
                matchScore += (1 - Math.abs(userVal - fontVal));
            } else {
                if (Array.isArray(fontVal)) {
                    matchScore += fontVal.includes(userVal) ? 1 : 0;
                } else {
                    matchScore += (fontVal === userVal) ? 1 : 0;
                }
            }
        });

        results.push({ ...font, score: matchScore / answeredCount });
    });

    results.sort((a, b) => b.score - a.score);

    resBox.innerHTML = "";
    results.slice(0, 20).forEach(res => {
        const div = document.createElement("div");
        div.className = "result-item";
        div.style.opacity = activeKeys.length > 0 ? (0.6 + res.score * 0.4) : 1;
        
        div.innerHTML = `
            <a href="${res.url || '#'}" target="_blank" class="font-link">
                <span style="font-size:${14 + res.score*4}px; font-weight:${400 + Math.round(res.score*300)}">${res.name}</span>
            </a>
            ${activeKeys.length > 0 ? `<span class="match-score">${Math.round(res.score * 100)}%</span>` : ''}
        `;
        resBox.appendChild(div);
    });
}

function nextStep() {
    if (currentStep < dynamicFeatureOrder.length - 1) {
        if (selectedAnswers[dynamicFeatureOrder[currentStep]] === undefined) {
            selectedAnswers[dynamicFeatureOrder[currentStep]] = null;
        }
        currentStep++;
        renderQuestion();
    }
}

function prevStep() {
    if (currentStep > 0) {
        currentStep--;
        renderQuestion();
    }
}

function renderHistory() {
    const box = document.getElementById("historyChips");
    box.innerHTML = "";
    Object.keys(selectedAnswers).forEach(key => {
        const val = selectedAnswers[key];
        if (val === undefined) return;
        const chip = document.createElement("div");
        chip.className = "chip history";
        chip.innerText = `${database.features[key].label_fa}: ${val === null ? '؟' : val}`;
        chip.onclick = () => { 
            currentStep = dynamicFeatureOrder.indexOf(key); 
            renderQuestion(); 
        };
        box.appendChild(chip);
    });
}

function updateURL() {
    const params = new URLSearchParams();
    const encoded = dynamicFeatureOrder.map(k => {
        const v = selectedAnswers[k];
        return v === undefined ? 'x' : (v === null ? 'u' : v);
    }).join('|');
    params.set("q", btoa(encodeURIComponent(encoded)));
    history.replaceState(null, "", "?" + params.toString());
}

function loadFromURL() {
    const params = new URLSearchParams(location.search);
    const q = params.get("q");
    if (!q) return;
    try {
        const decoded = decodeURIComponent(atob(q)).split('|');
        decoded.forEach((val, i) => {
            const key = dynamicFeatureOrder[i];
            if (!key || val === 'x') return;
            selectedAnswers[key] = val === 'u' ? null : (isNaN(val) ? val : parseFloat(val));
        });
    } catch(e) { console.error("URL Load Error"); }
}

function resetAll() {
    selectedAnswers = {};
    currentStep = 0;
    history.replaceState(null, "", window.location.pathname);
    renderQuestion();
    updateResults();
}

window.onload = init;
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Persian Font Identifier – Enhanced UX MVP</title>

<style>
body {
  font-family: sans-serif;
  max-width: 900px;
  margin: 40px auto;
  background: #f4f4f4;
}

h1 { text-align: center; }

.card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
}

button {
  padding: 8px 16px;
  cursor: pointer;
  margin-top: 15px;
  margin-left: 5px;
}

.progress-bar-container {
  background: #ddd;
  height: 10px;
  border-radius: 5px;
  margin-bottom: 15px;
}

.progress-bar {
  height: 10px;
  background: #4a78ff;
  width: 0%;
  border-radius: 5px;
  transition: width 0.3s ease;
}

/* Chips */
.chip-container {
  margin-top: 10px;
}

.chip {
  display: inline-block;
  padding: 6px 14px;
  margin: 4px;
  background: #eee;
  border-radius: 20px;
  cursor: pointer;
  transition: 0.2s;
  font-size: 14px;
}

.chip:hover {
  background: #dce4ff;
}

.chip.selected {
  background: #4a78ff;
  color: white;
}

/* Results */
.result {
  padding: 8px;
  margin-bottom: 6px;
  border-radius: 6px;
  font-size: 14px;
  background: #e8f0ff;
}

.result.top {
  background: #d4e3ff;
  border: 2px solid #4a78ff;
  font-weight: bold;
}

.summary-item {
  background: #f0f0f0;
  padding: 6px;
  border-radius: 6px;
  margin-bottom: 4px;
  font-size: 13px;
}
</style>
</head>
<body>

<h1>Font Finder – Enhanced UX</h1>

<div class="card">
  <div class="progress-bar-container">
    <div class="progress-bar" id="progressBar"></div>
  </div>

  <div id="questionContainer"></div>

  <div id="navigationButtons">
    <button onclick="prevStep()">سؤال قبلی</button>
    <button id="nextBtn" onclick="nextStep()">سؤال بعدی</button>
  </div>
</div>

<div class="card">
  <h3>خلاصه انتخاب‌ها:</h3>
  <div id="summary"></div>

  <h3>رتبه‌بندی فعلی:</h3>
  <div id="liveResults"></div>
</div>

<script>
let database;
let featureKeys = [];
let currentStep = 0;
let selectedAnswers = {};
let finalMode = false;

fetch('database.json')
  .then(res => res.json())
  .then(data => {
    database = data;
    featureKeys = Object.keys(database.features);
    renderQuestion();
    updateLiveResults();
  });

function renderQuestion() {
  const key = featureKeys[currentStep];
  const feature = database.features[key];
  const container = document.getElementById("questionContainer");

  updateProgress();
  container.innerHTML = `<label>${feature.label_fa}</label>`;

  if (feature.type === "categorical") {
    const chipContainer = document.createElement("div");
    chipContainer.className = "chip-container";

    feature.values.forEach(value => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.innerText = value;

      if (selectedAnswers[key] === value)
        chip.classList.add("selected");

      chip.onclick = () => {
        selectedAnswers[key] = value;
        renderQuestion();
        updateLiveResults();
        renderSummary();
      };

      chipContainer.appendChild(chip);
    });

    container.appendChild(chipContainer);
  }

  if (feature.type === "numeric") {
    const input = document.createElement("input");
    input.type = "range";
    input.min = 0;
    input.max = 1;
    input.step = 0.1;
    input.value = selectedAnswers[key] || 0.5;

    const label = document.createElement("div");
    label.innerText = input.value;

    input.oninput = () => {
      selectedAnswers[key] = input.value;
      label.innerText = input.value;
      updateLiveResults();
      renderSummary();
    };

    container.appendChild(input);
    container.appendChild(label);
  }

  updateNavigationButtons();
}

function updateNavigationButtons() {
  const nextBtn = document.getElementById("nextBtn");

  if (currentStep === featureKeys.length - 1) {
    nextBtn.innerText = "مشاهده نتایج نهایی";
    nextBtn.onclick = () => {
      finalMode = true;
      highlightTopResults();
    };
  } else {
    nextBtn.innerText = "سؤال بعدی";
    nextBtn.onclick = nextStep;
  }
}

function nextStep() {
  if (currentStep < featureKeys.length - 1)
    currentStep++;

  renderQuestion();
}

function prevStep() {
  if (currentStep > 0)
    currentStep--;

  renderQuestion();
}

function calculateScores() {
  return database.fonts.map(font => {
    let score = 0;
    let total = 0;

    for (let key in selectedAnswers) {
      const value = selectedAnswers[key];
      const fontValue = font.features[key];
      total++;

      if (Array.isArray(fontValue)) {
        if (fontValue.includes(value)) score++;
      } else {
        const diff = Math.abs(parseFloat(fontValue) - parseFloat(value));
        score += Math.max(0, 1 - diff);
      }
    }

    const percentage = total > 0 ? Math.round((score / total) * 100) : 0;

    return { name: font.name, percentage };
  }).sort((a,b)=>b.percentage - a.percentage);
}

function updateLiveResults() {
  const container = document.getElementById("liveResults");
  container.innerHTML = "";

  const results = calculateScores();

  results.forEach(r => {
    container.innerHTML += `
      <div class="result">
        <strong>${r.name}</strong> — ${r.percentage}%
      </div>
    `;
  });
}

function highlightTopResults() {
  const container = document.getElementById("liveResults");
  container.innerHTML = "";

  const results = calculateScores();

  const topScore = results[0].percentage;
  const threshold = 15; // اختلاف معنادار

  results.forEach(r => {
    const isTop = (topScore - r.percentage) > threshold ? false : true;

    container.innerHTML += `
      <div class="result ${isTop ? 'top' : ''}">
        <strong>${r.name}</strong> — ${r.percentage}%
      </div>
    `;
  });
}

function renderSummary() {
  const container = document.getElementById("summary");
  container.innerHTML = "";

  Object.entries(selectedAnswers).forEach(([key,value]) => {
    const label = database.features[key].label_fa;
    container.innerHTML += `
      <div class="summary-item">
        ${label}: ${value}
      </div>
    `;
  });
}

function updateProgress() {
  const percent = ((currentStep+1) / featureKeys.length) * 100;
  document.getElementById("progressBar").style.width = percent + "%";
}
</script>

</body>
</html>

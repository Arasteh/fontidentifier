<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Font Finder Pro | جستجوگر پیشرفته فونت</title>
    <style>
        :root {
            --primary: #4a78ff;
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #333;
            --text-light: #666;
            --border: #edf0f5;
            --chip-bg: #f0f0f0;
            --visual-bg: #fdfdfd;
        }

        /* حالت تاریک خودکار */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #121212;
                --card: #1e1e1e;
                --text: #e0e0e0;
                --text-light: #aaa;
                --border: #333;
                --chip-bg: #2d2d2d;
                --visual-bg: #1a1a1a;
            }
            .rect.base { background: #444 !important; }
            .circle.fixed { background: #444 !important; }
            button { background: #333 !important; color: #eee !important; }
            .result-item { background: #252525 !important; }
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }
        .container { max-width: 1100px; margin: 0 auto; }
        .layout { display: grid; grid-template-columns: 1fr 340px; gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); height: fit-content; }
        
        h1 { color: var(--primary); margin-bottom: 25px; text-align: center; font-size: 24px; }
        h3 { margin-top: 0; font-size: 16px; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; }
        
        .chip {
            display: inline-block;
            padding: 8px 16px;
            margin: 4px;
            background: var(--chip-bg);
            color: var(--text);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }
        .chip.selected { background: var(--primary); color: white; }
        .chip.history { background: rgba(74, 120, 255, 0.1); color: var(--primary); font-size: 11px; padding: 4px 10px; }

        .visual-container {
            margin: 20px 0;
            background: var(--visual-bg);
            border-radius: 10px;
            border: 1px dashed var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .ratio-visual {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 30px;
            height: 140px;
            width: 100%;
            position: relative;
            cursor: ns-resize;
            user-select: none;
        }
        .rect {
            width: 40px;
            background: var(--primary);
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: height 0.1s ease;
            pointer-events: none;
        }
        .rect.base { background: #ddd; height: 100%; border-radius: 4px; }
        .rect-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
        }

        .contrast-visual {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 50px;
            height: 100px;
            width: 100%;
        }
        .circle-wrapper { width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; position: relative; }
        .circle { background: var(--primary); border-radius: 50%; transition: all 0.2s ease; }
        .circle.fixed { width: 60px; height: 60px; background: #ddd; }
        .circle.dynamic { width: 60px; height: 60px; }

        .slider-box { width: 100%; max-width: 300px; }
        input[type=range] { width: 100%; cursor: pointer; }

        .result-item {
            padding: 10px 14px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: var(--card);
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
        }
        .font-link { text-decoration: none; color: inherit; display: flex; align-items: center; gap: 8px; flex-grow: 1; }
        .font-link:hover .font-name { color: var(--primary); }
        .weight-name {
            font-size: 10px;
            color: var(--text-light);
            background: var(--chip-bg);
            padding: 1px 6px;
            border-radius: 4px;
        }
        .match-score { font-size: 14px; color: var(--primary); font-weight: bold; }

        .controls { display: flex; justify-content: space-between; margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border); }
        button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; background: #eee; color: #333; font-family: inherit; font-size: 13px; transition: 0.2s; }
        button#nextBtn { background: var(--primary); color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .hidden { display: none; }

        @media(max-width: 900px) { .layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <h1>جستجوگر فونت</h1>

    <div class="layout">
        <div class="card">
            <div id="historyChips" style="margin-bottom: 15px;"></div>
            <div id="questionContainer">
                <p style="text-align:center; color:var(--text-light);">در حال بارگذاری و تحلیل داده‌ها...</p>
            </div>

            <div class="controls">
                <div>
                    <button onclick="prevStep()" id="prevBtn">قبلی</button>
                    <button id="nextBtn" onclick="nextStep()">نمی‌دانم / بعدی</button>
                </div>
                <button onclick="resetAll()" style="color: var(--text-light); background: transparent;">شروع از نو</button>
            </div>
        </div>

        <div class="card">
            <h3>نتایج تطبیق یافته</h3>
            <div id="results"></div>
        </div>
    </div>
</div>

<script>
let database = null;
let featureKeys = [];
let currentStep = 0;
let selectedAnswers = {};

async function init() {
    try {
        const response = await fetch('database.json');
        if (!response.ok) throw new Error('فایل دیتابیس یافت نشد.');
        database = await response.json();
        
        // بهینه‌سازی ترتیب سوالات بر اساس تنوع داده‌ها (Entropy-based)
        featureKeys = sortFeaturesByImportance(database);
        
        loadFromURL();
        renderQuestion();
        updateResults();
    } catch (error) {
        console.error('Error loading database:', error);
        document.getElementById("questionContainer").innerHTML = 
            `<p style="color:red; text-align:center;">خطا در بارگذاری دیتابیس. لطفا فایل database.json را بررسی کنید.</p>`;
    }
}

/**
 * مرتب‌سازی ویژگی‌ها بر اساس قدرت تفکیک
 * سوالاتی که مقادیر متنوع‌تری بین فونت‌ها دارند زودتر پرسیده می‌شوند
 */
function sortFeaturesByImportance(db) {
    const keys = Object.keys(db.features);
    const fontData = db.fonts;

    const scores = keys.map(key => {
        let values = [];
        fontData.forEach(f => {
            // استخراج مقدار از فونت یا وزن‌های آن
            if (f.features && f.features[key] !== undefined) {
                values.push(f.features[key]);
            } else if (f.weights) {
                Object.values(f.weights).forEach(w => {
                    if (w[key] !== undefined) values.push(w[key]);
                });
            }
        });

        // محاسبه میزان تنوع (Unique values ratio)
        const uniqueCount = new Set(values.flat()).size;
        const importance = uniqueCount / (db.features[key].type === 'numeric' ? 5 : 1); 
        
        return { key, importance };
    });

    return scores.sort((a, b) => b.importance - a.importance).map(s => s.key);
}

function updateURL() {
    if (!database) return;
    const params = new URLSearchParams();
    const data = {};
    featureKeys.forEach(key => {
        if (selectedAnswers[key] !== undefined) data[key] = selectedAnswers[key];
    });
    if (Object.keys(data).length > 0) {
        params.set("state", btoa(JSON.stringify(data)));
        history.replaceState(null, "", "?" + params.toString());
    }
}

function loadFromURL() {
    try {
        const params = new URLSearchParams(location.search);
        const state = params.get("state");
        if (state) selectedAnswers = JSON.parse(atob(state));
    } catch(e) { console.error("URL Load Error", e); }
}

function renderQuestion() {
    if (!database) return;
    const key = featureKeys[currentStep];
    const feature = database.features[key];
    const container = document.getElementById("questionContainer");
    const nextBtn = document.getElementById("nextBtn");
    const prevBtn = document.getElementById("prevBtn");
    
    prevBtn.disabled = currentStep === 0;
    container.innerHTML = `<h4 style="margin:0 0 15px 0; color:var(--text);">${feature.label_fa}</h4>`;
    renderHistory();

    const currentVal = selectedAnswers[key];
    
    // مدیریت وضعیت دکمه بعدی
    if (currentStep >= featureKeys.length - 1) {
        nextBtn.innerText = "مشاهده نتایج نهایی";
    } else {
        nextBtn.innerText = (currentVal === undefined || currentVal === null) ? "نمی‌دانم / بعدی" : "بعدی";
    }

    if (feature.type === "categorical") {
        const chipContainer = document.createElement("div");
        feature.values.forEach(val => {
            const chip = document.createElement("div");
            chip.className = `chip ${currentVal === val ? 'selected' : ''}`;
            chip.innerText = val;
            chip.onclick = () => { 
                selectedAnswers[key] = val; 
                updateURL(); 
                renderQuestion(); 
                updateResults(); 
            };
            chipContainer.appendChild(chip);
        });
        container.appendChild(chipContainer);
    }

    if (feature.type === "numeric") {
        const val = currentVal ?? 0.5;
        const visualWrap = document.createElement("div");
        visualWrap.className = "visual-container";

        if (key === 'contrast' || feature.label_fa.includes("تضاد") || feature.label_fa.includes("کنتراست")) {
            visualWrap.innerHTML = `
                <div class="contrast-visual">
                    <div class="circle-wrapper"><div class="circle fixed"></div></div>
                    <div class="circle-wrapper"><div class="circle dynamic" id="dynCircle" style="width:${60 * (1.1 - val)}px; height:${60 * (1.1 - val)}px"></div></div>
                </div>
                <div class="slider-box">
                    <input type="range" min="0" max="1" step="0.1" value="${val}" id="numSlider">
                    <div style="text-align:center; font-size:12px; margin-top:5px; color:var(--text-light);">مقدار: <span id="numVal">${Math.round(val*100)}%</span></div>
                </div>
            `;
        } else {
            visualWrap.innerHTML = `
                <div class="ratio-visual" id="barVisual">
                    <div class="rect" id="dragRect" style="height: ${val * 100}%"><span class="rect-label">${Math.round(val*100)}%</span></div>
                    <div class="rect base"><span class="rect-label">۱۰۰٪</span></div>
                </div>
                <div style="margin-top:10px; font-size:12px; color:var(--text-light);">برای تغییر بکشید</div>
            `;
        }

        const slider = visualWrap.querySelector('#numSlider');
        if (slider) {
            slider.addEventListener('input', (e) => {
                const v = parseFloat(e.target.value);
                document.getElementById('numVal').innerText = Math.round(v * 100) + "%";
                const dyn = document.getElementById('dynCircle');
                dyn.style.width = dyn.style.height = (60 * (1.1 - v)) + "px";
                selectedAnswers[key] = v;
                updateURL();
                updateResults();
                nextBtn.innerText = "بعدی";
            });
        }

        const barVisual = visualWrap.querySelector('#barVisual');
        if (barVisual) {
            const updateBar = (e) => {
                const rect = barVisual.getBoundingClientRect();
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                let percent = 1 - ((clientY - rect.top) / rect.height);
                percent = Math.max(0, Math.min(1, Math.round(percent * 10) / 10));
                
                selectedAnswers[key] = percent;
                renderQuestion();
                updateResults();
                updateURL();
            };
            barVisual.onmousedown = () => { window.onmousemove = updateBar; window.onmouseup = () => window.onmousemove = null; };
            barVisual.ontouchmove = (e) => { e.preventDefault(); updateBar(e); };
        }
        
        container.appendChild(visualWrap);
    }
}

function nextStep() {
    if (currentStep < featureKeys.length - 1) {
        if (selectedAnswers[featureKeys[currentStep]] === undefined) selectedAnswers[featureKeys[currentStep]] = null;
        currentStep++;
        renderQuestion();
    } else {
        updateResults(); // نمایش نهایی
    }
}

function prevStep() {
    if (currentStep > 0) { currentStep--; renderQuestion(); }
}

function renderHistory() {
    const box = document.getElementById("historyChips");
    box.innerHTML = "";
    Object.keys(selectedAnswers).forEach(key => {
        const val = selectedAnswers[key];
        const chip = document.createElement("div");
        chip.className = "chip history";
        const label = database.features[key].label_fa;
        chip.innerText = `${label}: ${val === null ? '؟' : (typeof val === 'number' ? Math.round(val*100)+'%' : val)}`;
        chip.onclick = () => { currentStep = featureKeys.indexOf(key); renderQuestion(); };
        box.appendChild(chip);
    });
}

/**
 * سیستم امتیازدهی اصلاح شده
 * استفاده از تابع گوسی برای اعداد جهت پاداش به نزدیکی و جریمه ملایم دوری
 */
function updateResults() {
    if (!database) return;
    const resBox = document.getElementById("results");
    resBox.innerHTML = "";

    const activeEntries = Object.entries(selectedAnswers).filter(([_, v]) => v !== null && v !== undefined);
    let finalFlatResults = [];

    database.fonts.forEach(font => {
        const checkMatch = (data) => {
            let totalScore = 0;
            if (activeEntries.length === 0) return 0;

            activeEntries.forEach(([key, userVal]) => {
                let fontVal = data[key] !== undefined ? data[key] : (font.features ? font.features[key] : undefined);
                if (fontVal === undefined) return;

                if (Array.isArray(fontVal)) {
                    totalScore += fontVal.includes(userVal) ? 1 : 0;
                } else if (typeof fontVal === 'number' && typeof userVal === 'number') {
                    // اصلاح باگ امتیازدهی: استفاده از معکوس فاصله خطی با دقت بیشتر
                    const diff = Math.abs(fontVal - userVal);
                    totalScore += Math.max(0, 1 - (diff * 1.5)); // جریمه منطقی برای فاصله
                } else {
                    totalScore += (fontVal === userVal) ? 1 : 0;
                }
            });
            return totalScore / activeEntries.length;
        };

        if (font.weights) {
            Object.keys(font.weights).forEach(wName => {
                const s = checkMatch(font.weights[wName]);
                finalFlatResults.push({ ...font, weight: wName, score: s });
            });
        } else {
            const s = checkMatch(font.features || {});
            finalFlatResults.push({ ...font, weight: null, score: s });
        }
    });

    // مرتب‌سازی
    if (activeEntries.length === 0) {
        finalFlatResults = finalFlatResults.sort(() => Math.random() - 0.5).slice(0, 8);
    } else {
        finalFlatResults = finalFlatResults
            .filter(r => r.score > 0.1)
            .sort((a, b) => b.score - a.score);
    }

    if (finalFlatResults.length === 0) {
        resBox.innerHTML = "<p style='color:var(--text-light); text-align:center; font-size:13px;'>موردی با این مشخصات یافت نشد.</p>";
        return;
    }

    finalFlatResults.forEach(res => {
        const div = document.createElement("div");
        div.className = "result-item";
        div.innerHTML = `
            <a href="${res.url || '#'}" target="_blank" class="font-link">
                <span class="font-name" style="font-weight: ${res.weight?.includes('Bold') ? 'bold' : 'normal'}">${res.name}</span>
                ${res.weight ? `<span class="weight-name">${res.weight}</span>` : ''}
            </a>
            <span class="match-score">${Math.round(res.score * 100)}%</span>
        `;
        resBox.appendChild(div);
    });
}

function resetAll() {
    selectedAnswers = {};
    currentStep = 0;
    history.replaceState(null, "", window.location.pathname);
    renderQuestion();
    updateResults();
}

init();
</script>
</body>
</html>